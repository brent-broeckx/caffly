generator client {
  provider = "prisma-client-js"
  engineType = "client"
}

datasource db {
  provider = "sqlite"
}

enum MessageType {
  TEXT
  CODE
  DIFF
  SYSTEM
}

enum PullRequestState {
  OPEN
  DRAFT
  MERGED
  CLOSED
}

enum BuildState {
  PASSED
  FAILED
  RUNNING
  QUEUED
  CANCELED
  UNKNOWN
}

model User {
  id             String       @id @default(cuid())
  githubUserId   String?      @unique
  username       String?
  displayName    String?
  avatarUrl      String?
  name           String?
  email          String?      @unique
  emailVerified  DateTime?
  image          String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  roomMembership RoomMember[]
  projectMemberships ProjectMember[]
  createdProjects Project[]
  sentMessages   Message[]
  accounts       Account[]
  sessions       Session[]
}

model Account {
  id                 String  @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String?
  access_token       String?
  encryptedAccessToken  String?
  encryptedRefreshToken String?
  encryptedIdToken      String?
  tokenKeyVersion       Int     @default(1)
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String?
  session_state      String?
  user               User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id            String   @id @default(cuid())
  sessionToken  String   @unique
  userId        String
  expires       DateTime
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier    String
  token         String   @unique
  expires       DateTime

  @@unique([identifier, token])
}

model Project {
  id          String          @id @default(cuid())
  name        String
  slug        String          @unique
  description String?
  createdById String
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  createdBy   User            @relation(fields: [createdById], references: [id], onDelete: Cascade)
  members     ProjectMember[]
  rooms       Room[]
}

model ProjectMember {
  id        String   @id @default(cuid())
  projectId String
  userId    String
  role      String   @default("member")
  joinedAt  DateTime @default(now())
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
}

model Room {
  id             String       @id @default(cuid())
  projectId      String
  name           String
  repositoryId   String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  project        Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  roomMembers    RoomMember[]
  messages       Message[]
  repository     Repository?  @relation(fields: [repositoryId], references: [id])
}

model RoomMember {
  id        String   @id @default(cuid())
  roomId    String
  userId    String
  role      String   @default("member")
  joinedAt  DateTime @default(now())
  room      Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([roomId, userId])
}

model Message {
  id          String      @id @default(cuid())
  roomId      String
  senderId    String
  type        MessageType @default(TEXT)
  content     String
  metadata    String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  room        Room        @relation(fields: [roomId], references: [id], onDelete: Cascade)
  sender      User        @relation(fields: [senderId], references: [id], onDelete: Cascade)
}

model Repository {
  id              String               @id @default(cuid())
  provider        String               @default("github")
  externalRepoId  String
  owner           String
  name            String
  fullName        String
  defaultBranch   String?
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  rooms           Room[]
  pullRequests    PullRequestSnapshot[]
  ciStatuses      CiStatusSnapshot[]

  @@unique([provider, externalRepoId])
}

model PullRequestSnapshot {
  id                String           @id @default(cuid())
  repositoryId      String
  providerPrId      String
  number            Int
  title             String
  authorUsername    String
  state             PullRequestState @default(OPEN)
  reviewStatus      String?
  sourceBranch      String?
  targetBranch      String?
  url               String
  fetchedAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  repository        Repository       @relation(fields: [repositoryId], references: [id], onDelete: Cascade)

  @@unique([repositoryId, providerPrId])
}

model CiStatusSnapshot {
  id                String      @id @default(cuid())
  repositoryId      String
  providerRunId     String
  workflowName      String
  branch            String?
  commitSha         String?
  state             BuildState  @default(UNKNOWN)
  detailsUrl        String?
  fetchedAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  repository        Repository  @relation(fields: [repositoryId], references: [id], onDelete: Cascade)

  @@unique([repositoryId, providerRunId])
}